<script>
  let theme = localStorage.getItem('theme') ?? 'dark';

  const generateNewScript = (theme: string) => {
    if (theme !== 'dark' && theme !== 'light') {
      theme = 'dark';
    }

    let script = document.createElement('script');

    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', 'sonim1/dev-blog-giscus');
    script.setAttribute('data-repo-id', 'R_kgDOLAKnJg');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDOLAKnJs4CcJx9');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '0');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-lang', 'en');
    script.setAttribute('loading', 'lazy');
    script.crossOrigin = 'anonymous';
    script.async = true;

    script.setAttribute('data-theme', theme);
    return script;
  };

  // Add a script tag to the document.
  let script = generateNewScript(theme);
  const giscusElement = document.getElementById('giscus-section');
  giscusElement?.appendChild(script);

  function setTheme(theme: 'dark' | 'light') {
    // Remove giscus
    giscusElement?.removeChild(script);
    document.querySelector('.giscus')?.remove();

    // Add the new giscus 
    script = generateNewScript(theme);
    giscusElement?.appendChild(script);
  }

  // Function to read and set the theme from localStorage
  function updateThemeFromLocalStorage() {
    const storedTheme = localStorage.getItem('theme') ?? 'dark';
    if (storedTheme === 'dark' || storedTheme === 'light') {
      setTheme(storedTheme);
    }
  }

  // Event listener to detect changes in localStorage
  window.addEventListener('storage', function (event) {
    if (event.key === 'theme') {
      updateThemeFromLocalStorage();
    }
  });
</script>
